# Минималистичная, но Мощная Система Бэкапов

Эта система бэкапов разработана для простоты, надежности и высокой производительности. Всего \~350 строк Python-кода и маленький JSON-конфиг позволяют работать с сложными сценариями резервного копирования.

## Как это работает

* **Источник → Зеркало → Инкрементные Бэкапы**

  * `src` — ваши исходные файлы
  * `mirror` — актуальная копия всех отслеживаемых файлов
  * `backup_xxx` — инкрементные копии изменений и удалений

* **Математика Множеств**

  * Чистые операции множеств для определения новых, измененных и удаленных файлов
  * Нет дубликатов, нет лишних сканов
  * Предсказуемое и детерминированное поведение

* **Инкрементные Бэкапы**

  * Только новые/измененные файлы + удаленные файлы
  * Жесткие ссылки (hardlink) на зеркало экономят место
  * JSON-метаданные фиксируют все операции

## Конфигурация (Простой JSON)

### Директории:

```json
{
  "include_dirs": [".config", "Документы"],
  "track_dirs": [],
  "exclude_dirs": ["tmp", "Изображения"]
}
```

### Файлы:

```json
{
  "include_files": [".*", "*.txt:rec"],
  "track_files": [],
  "exclude_files": ["*.tmp", "*.log:rec"]
}
```

**Особенности:**

* `:rec` → рекурсивный поиск на любом уровне
* Шаблоны без `:rec` → только корневая директория
* Директории — пути относительно `src`
* Файлы — паттерны, для гибкого управления

## Основные моменты реализации

### Производительность

* Параллельное копирование файлов (ThreadPoolExecutor)
* Минимум операций ввода/вывода
* Молниеносные операции с множествами

### Надежность

* Atomic запись JSON → предотвращает повреждение данных
* Обработка всех ошибок чтения/записи файлов
* Безопасное удаление пустых директорий
* Все edge cases учтены

### Инкременты

* Категории файлов:

  * `новые/измененные` → hardlink на зеркало + копия в инкремент
  * `удаленные` → hardlink на зеркало + запись в инкремент

* Метаданные содержат: размер, mtime, путь, тип операции и статистику

### Система шаблонов

* Рекурсивно: `*.txt:rec` → все уровни
* Некурсивно: `.*` → только корень
* Исключения: `*.tmp`, `*.log:rec`
* Преимущество: строго, предсказуемо, без магии

### Логика Множеств

```text
новые_файлы = current_tracked - old_mirror
удаленные_файлы = old_mirror - current_tracked
обновленные_файлы = сравнение size & mtime
```

* Полностью детерминированно — предсказуемые бэкапы

### Atomic & Safe Operations

* Временные `.tmp` файлы → атомарная замена JSON
* Hardlink вместо копий → экономия диска и времени
* Параллельная обработка → быстрее для тысяч файлов

### Статистика

После бэкапа доступно:

* Всего файлов в зеркале
* Количество отслеживаемых файлов
* Файлы, удаленные из зеркала
* Новые/измененные/удаленные файлы в инкременте

### Минимальная сложность

* 350 строк Python → легко читать, модифицировать и поддерживать
* 10 строк конфига → легко настроить include/exclude правила
* 0 зависимостей → чистый Python

## Ключевые преимущества

* Без магии — полностью явные и предсказуемые операции
* Экономия места — hardlink + инкрементные бэкапы
* Полный контроль над операциями
* Быстро, безопасно, надежно
* Подходит для личного и профессионального использования

## Быстрый старт

1. Создайте `config.json` в корне вашего проекта.
2. Настройте директории и шаблоны файлов.
3. Запустите:

```bash
python3 backup.py --config config.json
```

4. Проверьте `mirror/` для текущего состояния и `backup_YYYYMMDD_HHMMSS/` для инкрементов.
5. Наслаждайтесь минималистичным и высокопроизводительным бэкапом!

## Итог

350 строк Python + 10 строк конфига → профессиональная система бэкапов: быстрая, безопасная, предсказуемая и гибкая.
