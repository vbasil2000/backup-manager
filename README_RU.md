# Минималистичная, но Мощная Система Бэкапов

Эта система бэкапов создана, чтобы быть простой, надежной и высокопроизводительной. Всего \~350 строк кода Python и небольшой JSON-конфиг позволяют справляться с любыми сценариями.

## Как работает

```
Source → Mirror → Incremental Backups
```

* `src` — исходные файлы
* `mirror` — актуальная копия всех отслеживаемых файлов
* `backup_xxx` — инкрементальные копии изменений и удалений

### Математика множеств

* Чистые операции над множествами для определения новых, изменённых и удалённых файлов
* Нет дубликатов и лишних сканов
* Предсказуемое и детерминированное поведение

### Инкрементальные бэкапы

* Только новые/изменённые и удалённые файлы
* Hardlink к mirror экономит место
* JSON-метаданные фиксируют все операции

## Конфигурация (Простой JSON)

### Директории

```json
{
  "include_dirs": [".config", "Documents"],
  "track_dirs": [],
  "exclude_dirs": []
}
```

* `exclude_dirs` нужен **только для удаления веток внутри включённых директорий**
* Остальные директории автоматически игнорируются

### Файлы

```json
{
  "include_files": [".*", "*.txt:rec"],
  "track_files": [],
  "exclude_files": ["*.tmp", "*.log:rec"]
}
```

* `:rec` → рекурсивный поиск на любом уровне
* Паттерны без `:rec` → только в корневой директории
* Исключения фильтруют ненужные файлы

## Особенности реализации

### Производительность

* Параллельное копирование файлов (`ThreadPoolExecutor`)
* Минимум операций ввода/вывода
* Молниеносные операции с множествами

### Надежность

* Atomic JSON-запись → предотвращает повреждение данных
* Обработка ошибок чтения/записи
* Безопасное удаление пустых директорий
* Все edge-cases учтены

### Инкременты

* Классификация файлов:

  * `new/changed` → hardlink к mirror + копия в инкремент
  * `deleted` → hardlink к mirror + запись в инкремент
* Метаданные содержат: размер, mtime, путь, тип операции, статистику

### Система паттернов

* Рекурсивные: `*.txt:rec` → все уровни
* Не рекурсивные: `.*` → только корень
* Исключения: `*.tmp`, `*.log:rec`
* Жесткий, предсказуемый, без магии

### Логика множеств

* `new_files = current_tracked - old_mirror`
* `deleted_files = old_mirror - current_tracked`
* `updated_files = compare size & mtime`
* Полностью детерминированные бэкапы

### Atomic & Safe Operations

* Временные `.tmp` файлы → атомарная замена JSON
* Hardlink вместо копирования → экономия места и времени
* Параллельная обработка → быстрее для тысяч файлов

### Статистика

После бэкапа доступно:

* Общее количество файлов в mirror
* Количество отслеживаемых файлов
* Удалённые файлы из mirror
* Новые/изменённые/удалённые файлы в инкременте

### Минимальная сложность

* 350 строк Python → легко читать, модифицировать и поддерживать
* 10 строк конфигурации → удобно настраивать include/exclude
* 0 зависимостей → чистый Python

### Ключевые преимущества

* Нет магии — всё явно и предсказуемо
* Экономия места — hardlink + инкременты
* Полный контроль над операциями
* Быстро, безопасно, надежно
* Подходит для личного и профессионального использования

## Начало работы

1. Создайте `config.json` в корне проекта.
2. Настройте директории и маски файлов.
3. Запустите:

```bash
python3 backup.py --config config.json
```

4. Проверяйте `mirror/` для текущего состояния и `backup_YYYYMMDD_HHMMSS/` для инкрементов.

Наслаждайтесь минималистичными, высокопроизводительными бэкапами!

---

**Итог:** 350 строк Python + 10 строк конфига → профессиональная система бэкапов, быстрая, безопасная, предсказуемая и гибкая.
